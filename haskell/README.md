# Onyx Music Game Toolkit (version _ONYXVERSION_)

By Michael Tolly <onyxite@gmail.com>

Onyx is a multipurpose build tool for Guitar-Hero/Rock-Band-like music games.
It can import and export a wide variety of formats, move parts around,
change song speed, fill in missing details, and assist with song authoring.

Built on work and research by:

  * Harmonix
  * TrojanNemo, emist (C3 CON Tools, Magma v2 mod)
  * No1mann (Magma v1 mod)
  * maxton, PikminGuts92 (LibForge/ForgeTool, milo lipsync help)
  * StackOverflow0x (MiloMod, milo venue help)
  * xorloser (ArkTool/DtbCrypt)
  * deimos (dtb2dta)
  * qwertymodo (Magma MOGG redirect)
  * Bloodline, Inventor (GHL MIDI format help)
  * DJ Shepherd (X360)
  * arkem (py360)
  * and many others!

Onyx is free software via the GNU General Public License v3; see LICENSE.txt.

New versions and source at: https://github.com/mtolly/onyxite-customs/releases

## Requirements

Windows version requires (I think) the Visual C++ runtime.
(If you can run Magma, you're good.)

Mac version requires Wine. You can use the official installer, or you can use
Homebrew (`brew install wine`). The app is compiled with Mojave (10.14.6), so
you probably need at least that version.

I haven't tested it myself but is likely that macOS Catalina (10.15) does not
support running Magma in Wine due to its lack of support for 32-bit programs.
For this reason, I recommend Mac users stay on Mojave if you wish to create Rock
Band CON files until a solution is found.

## Instructions

On Windows, run the installer, then run `onyx.exe` (or the installed shortcut).
On Mac, move `Onyx.app` to your Applications folder, and then run it.

## Supported Formats

Onyx can import the following song formats:

  * Rock Band 1/2/3 STFS (CON or LIVE) files

    * Both single-song files and packs are supported.

  * Magma (v1 or v2) RBA files

  * Frets on Fire / Phase Shift / Clone Hero formats

    * Both `notes.mid` and `notes.chart` are supported.
    * Both OGG Vorbis and MP3 audio are supported.
    * `song.ini` can be absent if using `notes.chart`.
    * Audio files must be named according to PS/CH conventions.

  * Magma (v1 or v2) projects (.rbproj)

  * Guitar Hero, Guitar Hero II, or Guitar Hero Encore: Rocks the 80s (PS2)

    * Extract the `.iso` contents, and then import either `GEN` or `MAIN.HDR`.

  * DTXMania (DrumMania / GuitarFreaks) simfiles (.dtx/.gda)

    * XG features (5-fret guitar/bass, extra drum pads) are supported.
    * Drums are translated to Pro Drums as well as Phase Shift Real Drums.
      (Real Drums display in the player but aren't yet included in PS output.)
    * Keysounded audio is rendered to stem files.
    * Currently only each instrument's highest difficulty from a `set.def`
      is imported as Expert, and difficulties below this are autogenerated.
      To import a specific difficulty directly, import its `.dtx` file.

## Batch Mode

First, load files into the Songs tab.
You can drag and drop files or folders onto the list, or browse with Add Song.
Folders will be searched for any recognized songs inside.
To remove a song, select its row in the tree, and press the Delete key.
To change the order of songs, select its row and press Ctrl+Up or Ctrl+Down
(Windows), or Cmd+Up or Cmd+Down (Mac).

At the bottom of the tab are toggles for whether specific instruments should
be imported. These can be helpful if unnecessary instrument parts are causing
compilation errors.

  * Rock Band 3 (360)

    Creates either a Rock Band 3 CON file or a Magma v2 project.

    Here is a sample of the steps performed when importing from FoF/PS/CH:

      * Add appropriate `[music_start]`, `[music_end]`, and `[end]` events
      * Generate an automatic `BEAT` track from MIDI time signatures
      * Add auto-generated (roughly CAT-quality) lower difficulties if missing
      * Import as much metadata as possible from `song.ini`
      * Apply the correct `delay` value from `song.ini` to the audio
      * Delay the song start by a few seconds if notes are present too early
      * Detect double drum roll lanes using the single lane note and fix them
      * Alter the tempo map to fix some instances of too-slow/too-fast tempos
      * Convert 5-lane drums to 4-lane using the standard Phase Shift rules
      * Convert Phase Shift "Real Drums" to RB by removing hihat pedal notes
      * Convert tap notes to HOPO notes
      * Remove some overdrive phrases if they produce invalid unison phrases,
        have no notes under them on any difficulty, or have no notes between
        two adjacent phrases on any difficulty

    If the "automatic tom markers" option is turned on, an FoF song that doesn't
    have any tom markers and that does not have "pro_drums = True" in the
    song.ini will have tom markers added over the whole drum part, under the
    assumption that Pro Drums have not been authored for the chart.

    Open notes from a PS or CH song will be translated to green notes. Sequences
    of notes adjacent to open notes will be moved up one fret if necessary to
    preserve motion.

    The song speed can be modified to produce sped up or slowed down songs.
    This will modify both the audio and MIDI, and add (X% Speed) to the title.
    For CON inputs this only works with unencrypted MOGG files.
    Different speed versions may not pass Magma in all cases, if certain events
    become too close together or too far apart.
    If this happens, you can produce a Magma project and then make the needed
    changes before compiling with Magma.

    A few options are available for moving Guitar/Bass/Keys parts:
    `Copy G to K`, `Swap G and K`, and `Swap B and K`. In all cases, force notes
    will be applied so charts keep their strum/HOPO notes correct when switched
    between Keys and Guitar/Bass. If `Copy G to K` is selected and a guitar stem
    is present, depending on the input format, the guitar audio will either be
    linked to both guitar and keys (for CON or RBA inputs) or moved to the
    backing track (for FoF/PS/CH and .rbproj inputs).

    By default, an input format like Phase Shift that can contain both 1x and
    2x Bass Pedal drums charts will generate two separate songs. If you are
    interested in only 1x or only 2x, select the appropriate Bass Pedal option.
    Songs that are detected as 2x Bass Pedal versions can also produce an
    automatic 1x version, using an algorithm to remove certain kick notes.

    When creating a Magma project, a REAPER project will also be generated
    so any remaining problems can be quickly edited and re-exported to MIDI.
    This avoids a few bugs in REAPER's own MIDI import function.
    It also applies most of the C3 template to the MIDI tracks,
    so you get note names, colored tracks, and RBN preview windows.
    Because this must generate WAV audio files to give to Magma,
    encrypted MOGG files in input rb3cons are unsupported.

    Tip: to process a song with a C3-encrypted MOGG, one option is to use
    the Phase Shift converter in C3 CON Tools which mixes the audio down to a
    single file, and then just supply the Phase Shift song to Onyx.

  * Rock Band 2 (360)

    Creates a CON file for Rock Band 2, using the following conversions:

      * removes RB3 added features like pro instruments, harmonies, bass solos,
        trill/tremolo, new drum animations
      * any 2-instrument unisons are made into 1-instrument OD phrases
      * converts VENUE to RB2 format
      * ensures lower difficulties have all colors used on Expert
      * adds (RB2 version) to the title to disambiguate when in RB3

    Then it will attempt to validate the song through Magma v1.
    If this succeeds, you're good to go.
    If it fails, it will still continue and simply copy the MIDI as-is.
    The result will still probably work; you just won't get lipsync animations.

    You can choose to drop the Keys part, or move it to Guitar or Bass.
    In the latter two cases, the RB3 "keytar" algorithm is more-or-less applied,
    so fast chords become HOPOs, and overlapping sustains are shortened.

  * Clone Hero/Phase Shift

    Generates a song folder (or zip file containing one) in Phase Shift format.
    These should play correctly in the latest free version of Phase Shift,
    the Steam version of Phase Shift, and the latest version of Clone Hero.
    Songs may also work in Frets on Fire X, but this is not guaranteed.

    Due to how the conversion is implemented, some non-RB features such as Dance
    mode, Real Drums, and Real Keys will not survive a PS-to-PS conversion.
    However other 5-fret charts such as `PART RHYTHM`, as well as Clone Hero
    6-fret tracks, should remain.

  * Rock Band 3 (Wii)

    Converts a collection of songs to a single RB3 pack in the format used by
    the Dolphin Wii emulator. This is primarily intended for people using
    Dolphin to record videos of songs.

    Only STFS (CON/LIVE) files should be selected. Convert any other formats to
    RB3 CON first if needed.

    Options are available for certain MIDI transformations useful for videos:

      * Remove activation drum fills
      * Remove the Mustang version of a Pro Guitar/Bass track, ensuring the
        Squier version (supporting more than 17 frets) will always be played
      * Unmute any muted Pro Guitar/Bass notes over fret 22. This allows you
        to include such notes while compiling with Magma, and then unmute
        them for recording the video

  * Preview

    Generates a JavaScript (Canvas) chart preview app for web browsers,
    which plays back the audio and displays all tracks in 2D "Beatmania" style.

    Supports all Rock Band 3 instrument tracks, including Pro Guitar/Bass/Keys,
    as well as Clone Hero's 6-fret (GHL) mode, 5-lane Drums, and PS Real Drums.

    A player folder will appear next to each song; open `index.html` to run.
    It can be run locally via `file://`, or hosted on a web server.

    Colors used for drawing the display can be tweaked by editing the file
    `customize.js`. In the future this will be improved to allow overriding
    all pixel sizes as well, so images will be further customizable.

## Other Tools

  * Fill in automatic lower difficulties (MIDI function)

    Generates CAT-like automatic reductions for empty difficulties in a MIDI.
    Quality is not guaranteed, but they should pass Magma.

    To use, ensure that there are no notes or events authored
    for a difficulty you want to be filled in.
    (For Pro Keys, remove the `PART REAL_KEYS_?` track entirely.)

    If a drum track with no animations is present, drum animations will also
    be generated. These are of somewhat higher quality than the ones Magma can
    generate, as they will always handle tom markers correctly, and have more
    of a preference for double strokes rather than crossing hands.

  * Find hanging Pro Keys notes (MIDI function)

    Looks for cases in a Pro Keys track where a range shift occurs less than
    1 second before a note that is not visible in the previous range.

  * Make Reaper project with RB template (MIDI function)

    Imports a MIDI file into a REAPER project. It avoids a few bugs in REAPER's
    own MIDI import function, and applies track names and note colors similar to
    the RBN or C3 project templates.

  * MOGG creator

    Generates an unencrypted MOGG file from a set of input audio files. The
    created files should work on Rock Band games, Guitar Hero II for Xbox 360,
    and newer games such as Audica, with a proper seek header.

    The channels of all the input files, which can be WAV, OGG, MP3, or FLAC,
    will be merged into one multichannel OGG file, and then prefixed with the
    MOGG header. As with the batch load screen, you can select a song row, and
    press Delete to remove it, Ctrl+Up to move it up in the list, or Ctrl+Down
    to move it down.

    As a special case, if you provide a single OGG file, it will not be
    reencoded, and will go unchanged into the MOGG file.

  * Lipsync dry vocals audio creation for Magma

    Two options for generating audio files to give to Magma's vocal animation
    generator.

      * Sine wave dryvox: the pitches from the vocal track become simple pitch
        tones. This is used by Onyx for Magma v1 (RB2) which is picky about
        matching the charted vocal pitches to the dry vocal file, and can error
        if it thinks they do not match.

        Currently slides are not yet supported.

      * Clipped dryvox: an input audio file, either a mixed song file or an
        isolated vocal file, is clipped so audio is only present during the
        vocal notes. This is used by Onyx when exporting Magma v2 projects.
