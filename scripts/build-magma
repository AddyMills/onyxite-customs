#!/usr/bin/env ruby

require 'yaml'

def system_(*args)
  STDERR.puts args.join(' ')
  result = system(*args)
  raise(IOError, "Command returned #{$?.exitstatus}") if result != true
end

readmes = Dir['songs/*/*/README.md']
readmes.each do |readme|
  yaml_file = readme.sub('README.md', 'song.yml')
  folder = File.dirname(yaml_file)
  puts ">>> SONG: #{folder}"
  yaml = YAML.load_file(yaml_file)
  audio = yaml['audio'].keys
  makes = []
  audio.each do |a|
    ['1p', '2p'].each do |p|
      makes += [
        "gen/#{a}/#{p}/countin.wav",
        "gen/#{a}/#{p}/magma/magma.rbproj",
        "gen/#{a}/#{p}/magma/notes.mid",
        "gen/#{a}/#{p}/magma/cover.bmp",
      ]
      expr = yaml['audio'][a]
      if a != 'jammit' && !(expr.is_a?(Hash) && expr.has_key?('song'))
        # audio is non-stems
        yaml['config'].each do |inst|
          makes += [
            "gen/#{a}/#{p}/magma/#{inst}.wav",
          ]
        end
      end
    end
  end
  Dir.chdir(folder) do
    system_("onyxbuild", "-q", *makes)
  end
end
