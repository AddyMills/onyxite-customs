#!/usr/bin/env ruby

require_relative 'common'

yamls = Dir['songs*/*/*/song.yml']
yamls.each do |yaml_file|
  folder = File.dirname(yaml_file)
  puts ">>> SONG: #{folder}"
  yaml = load_yaml_tree(yaml_file)
  next unless yaml.fetch('published', true)
  audio = yaml['plans'].keys
  makes = []
  audio.each do |a|
    ['1p', '2p'].each do |p|
      makes += [
        "gen/plan/#{a}/countin.wav",
        "gen/plan/#{a}/#{p}/magma/magma.rbproj",
        "gen/plan/#{a}/#{p}/magma/magma.c3",
        "gen/plan/#{a}/#{p}/magma/notes.mid",
        "gen/plan/#{a}/#{p}/magma/cover.bmp",
      ]
      plan_exprs = yaml['plans'][a]
      unless plan_exprs.has_key?('each')
        # we need to make dummy audio for instruments not present
        yaml['instruments'].each_key do |inst|
          inst = 'keys' if inst == 'pro-keys'
          unless plan_exprs.has_key?(inst)
            makes += ["gen/plan/#{a}/#{p}/magma/#{inst}.wav"]
            if inst == 'vocal'
              makes += ["gen/plan/#{a}/#{p}/magma/dryvox.wav"]
            end
          end
        end
      end
    end
  end
  Dir.chdir(folder) do
    system_("onyx", "build", "-q", *makes)
  end
end
