#!/usr/bin/env ruby

def system_(*args)
  STDERR.puts args.join(' ')
  result = system(*args)
  raise(IOError, "Command returned #{$?.exitstatus}") if result != true
end

readmes = `ls songs/*/*/README.md`.split "\n"
#readmes = ['dream-theater/6-00/README.md']
readmes.each do |readme|
  folder = File.dirname(readme)
  puts ">>> SONG: #{folder}"
  str = File.read(readme)
  audio = []
  pedals = []
  audio << 'album' if str.include?('`album`')
  audio << 'jammit' if str.include?('`jammit`')
  audio << 'hit' if str.include?('`hit`')
  audio << 'pledgemusic' if str.include?('`pledgemusic`')
  makes = []
  audio.each do |a|
    ['1p', '2p'].each do |p|
      makes += [
        "gen/#{a}/#{p}/countin.wav",
        "gen/#{a}/#{p}/magma/magma.rbproj",
        "gen/#{a}/#{p}/magma/notes.mid",
        "gen/#{a}/#{p}/magma/cover.bmp",
      ]
      if ['album', 'hit'].include? a
        makes += [
          "gen/#{a}/#{p}/magma/drums.wav",
        ]
        if str.include? 'Bass:'
          makes += [
            "gen/#{a}/#{p}/magma/bass.wav",
          ]
        end
        if str.include? 'Guitar:'
          makes += [
            "gen/#{a}/#{p}/magma/guitar.wav",
          ]
        end
      end
    end
  end
  Dir.chdir(folder) do
    system_("onyxbuild", "-q", *makes)
  end
end
